<div class="dashboard-container">
  <!-- Header -->
  <app-shared-header
    [pageTitle]="'Tes Kantuk'"
    [pageSubtitle]="'Analisis tingkat kantuk dan dampaknya pada performa mengemudi'"
    [showSleepTestButton]="!tesBerjalan"
    [showStopTestButton]="tesBerjalan"
    (sleepTestClick)="startSleepTest()"
    (stopTestClick)="stopSleepTest()"
  >
    <div class="action-buttons" slot="actions">
      <ion-button (click)="refreshData()" fill="clear" size="small">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="eksporData()" fill="clear" size="small">
        <ion-icon name="download-outline"></ion-icon>
      </ion-button>
    </div>
  </app-shared-header>

  <div class="webcam-section ion-padding">
    <h2 class="section-title">Real-Time Drowsiness Detection</h2>
    <div class="video-container">
      <video #videoElement autoplay muted playsinline></video>
      <canvas #canvasElement></canvas>
    </div>
    <div class="detection-status">
      <p>Status: <span [ngClass]="warnaStatus">{{ statusKantuk }}</span></p>
    </div>
  </div>

  <div class="dashboard-content">
    <!-- Current Status -->
    <div class="current-status">
      <div class="status-card">
        <div class="status-header">
          <h2>Status Saat Ini</h2>
          <div
            class="status-indicator"
            [style.background]="dapatkanWarnaKantuk(statistik.tingkatKantuk)"
          >
            {{ dapatkanLevelKantuk() }}
          </div>
        </div>
        <div class="status-content">
          <div class="status-metric">
            <div class="metric-value">{{ statistik.tingkatKantuk }}%</div>
            <div class="metric-label">Tingkat Kantuk</div>
          </div>
          <div class="status-metric">
            <div class="metric-value">
              {{ statistik.waktuReaksi }}s
            </div>
            <div class="metric-label">Waktu Reaksi</div>
          </div>
          <div class="status-metric">
            <div class="metric-value">{{ statistik.skorKognitif }}%</div>
            <div class="metric-label">Skor Kognitif</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">
          <ion-icon name="bed-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ statistik.totalTests }}</div>
          <div class="stat-label">Total Tes</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <ion-icon name="moon-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ statistik.sleepQuality }}%</div>
          <div class="stat-label">Kualitas Tidur</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <ion-icon name="trending-up-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">+{{ statistik.improvementRate }}%</div>
          <div class="stat-label">Peningkatan</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ statistik.testDuration }}</div>
          <div class="stat-label">Durasi Tes</div>
        </div>
      </div>
    </div>

    <!-- Warning Levels -->
    <div class="warning-levels-section">
      <h2 class="section-title">Tingkat Peringatan Kantuk</h2>
      <div class="warning-levels-grid">
        <div class="warning-level-card" *ngFor="let level of warningLevels">
          <div class="warning-header">
            <div class="warning-icon">
              <ion-icon
                [name]="level.level === 'Rendah' ? 'checkmark-circle' : level.level === 'Sedang' ? 'alert-circle' : 'warning'"
                [style.color]="level.color"
              ></ion-icon>
            </div>
            <div class="warning-title">
              <h3 [style.color]="level.color">{{ level.level }}</h3>
              <div class="warning-range">
                {{ 
                  level.level === 'Rendah' ? '0-30%' : 
                  level.level === 'Sedang' ? '31-70%' : '71-100%' 
                }}
              </div>
            </div>
          </div>
          <div class="warning-description">{{ level.description }}</div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <h2 class="section-title">Analisis Kantuk</h2>
      <div class="charts-grid">
        <!-- Tingkat Kantuk Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.tingkatKantuk.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.tingkatKantuk.data"
                >
                  <div class="bar-label">{{ data.name }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.value"
                      [style.background]="dapatkanWarnaKantuk(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value }}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Reaksi Mata Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.reaksiMata.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.reaksiMata.data"
                >
                  <div class="bar-label">{{ data.name }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.value"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value }}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kinerja Kognitif Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.kinerjaKognitif.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.kinerjaKognitif.data"
                >
                  <div class="bar-label">{{ data.name }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.value"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value }}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kualitas Tidur Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.kualitasTidur.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.kualitasTidur.data"
                >
                  <div class="bar-label">{{ data.name }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.value"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value }}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sleep Patterns -->
    <div class="sleep-patterns-section">
      <h2 class="section-title">Pola Kantuk Harian</h2>
      <div class="sleep-patterns-grid">
        <div class="pattern-card" *ngFor="let pattern of sleepPatterns">
          <div class="pattern-time">{{ pattern.time }}</div>
          <div class="pattern-metrics">
            <div class="pattern-metric">
              <span class="metric-label">Kantuk:</span>
              <span
                class="metric-value"
                [style.color]="dapatkanWarnaKantuk(pattern.sleepiness)"
              >
                {{ pattern.sleepiness }}%
              </span>
            </div>
            <div class="pattern-metric">
              <span class="metric-label">Reaksi:</span>
              <span class="metric-value">{{ pattern.reaction || '0' }}s</span>
            </div>
            <div class="pattern-metric">
              <span class="metric-label">Kognitif:</span>
              <span class="metric-value">{{ pattern.cognitive || '0' }}%</span>
            </div>
          <div
            class="pattern-quality"
            [style.color]="dapatkanWarnaKantuk(pattern.sleepiness)"
          >
            {{ getSleepQualityLabel(pattern.quality) }}
          </div>
        </div>
      </div>
    </div>
    <div class="recent-tests-section">
      <h2 class="section-title">Tes Terbaru</h2>
      <div class="recent-tests-list">
        <div class="test-item" *ngFor="let test of recentTests">
          <div
            class="test-status"
            [style.background]="getStatusColor(test.status)"
          ></div>
          <div class="test-details">
            <div class="test-time">{{ test.date | date:'shortTime' }}</div>
            <div class="test-metrics">
              <div class="test-metric">
                <span>Skor: {{ test.score }}%</span>
              </div>
              <div class="test-metric">
                <span>Status: {{ test.status }}</span>
              </div>
            </div>
            <div class="test-recommendation">
              {{ getRecommendation(test) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <div class="recommendations-section">
      <h2 class="section-title">Rekomendasi Tidur</h2>
      <div class="recommendations-grid">
        <div class="recommendation-card" *ngFor="let rec of recommendations">
          <div class="recommendation-icon">
            <ion-icon
              [name]="rec.icon"
              [style.color]="getPriorityColor(rec.priority)"
            ></ion-icon>
          </div>
          <div class="recommendation-content">
            <h3>{{ rec.title }}</h3>
            <p>{{ rec.description }}</p>
          </div>
          <div class="recommendation-priority">
            <span
              class="priority-badge"
              [style.background]="getPriorityColor(rec.priority)"
            >
              {{ rec.priority === 'high' ? 'Tinggi' : rec.priority === 'medium'
              ? 'Sedang' : 'Rendah' }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Trends -->
    <div class="trends-section">
      <h2 class="section-title">Tren Performa Mingguan</h2>
      <div class="trends-card">
        <div class="trends-chart">
          <div class="chart-title" style="margin-bottom: 12px;">Tingkat Kewaspadaan</div>
          <div class="chart-subtitle" style="margin-top: 8px; font-family: 'Roboto', sans-serif; font-size: 0.9rem; color: #666666; font-weight: 400;">Skor rata-rata harian</div>
          <div class="grid-lines">
            <div class="grid-line" style="bottom: 0%" data-value="60%"></div>
            <div class="grid-line" style="bottom: 25%" data-value="67.5%"></div>
            <div class="grid-line" style="bottom: 50%" data-value="75%"></div>
            <div class="grid-line" style="bottom: 75%" data-value="82.5%"></div>
            <div class="grid-line" style="bottom: 100%" data-value="90%"></div>
          </div>
          <div class="trend-bars">
            <div
              class="trend-bar"
              *ngFor="let trend of weeklyPerformanceData; let i = index"
            >
              <div class="trend-day">{{ trend.day }}</div>
              <div class="trend-bar-wrapper">
                <div
                  class="trend-bar-fill"
                  [style.height.%]="((trend.value - 60) / 30) * 100"
                  [class.highest]="trend.value === getHighestValue()"
                ></div>
              </div>
              <div class="trend-value">{{ trend.value }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
