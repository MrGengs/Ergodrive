<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <div class="logo">
        <img
          src="assets/logo/snapedit_1758626403883-removebg-preview.png"
          alt="ERGODRIVE Logo"
          class="logo-img"
        />
      </div>
    </div>
    <div class="header-center">
      <h1 class="welcome-title">Selamat datang kembali!</h1>
      <p class="welcome-subtitle">
        Berikut adalah analisis terbaru dari tes mengemudi.
      </p>
    </div>
    <div class="header-right">
      <div class="user-profile" (click)="openProfileModal()">
        <div class="avatar-container">
          <div class="user-avatar">
            <ng-container *ngIf="userInfo.photoURL; else initialAvatar">
              <img
                [src]="userInfo.photoURL"
                alt="Profile"
                class="profile-image"
                (load)="onImageLoad($event)"
                (error)="onImageError($event)"
                referrerpolicy="no-referrer"
              />
            </ng-container>
            <ng-template #initialAvatar>
              <span class="user-initial">{{ userInfo.initial }}</span>
            </ng-template>
          </div>
          <div class="online-indicator" *ngIf="userInfo.isOnline"></div>
        </div>
        <div class="user-info">
          <div class="user-name">{{ userInfo.name }}</div>
          <div class="user-status">{{ userInfo.status }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-content">
    <!-- Main Content -->
    <div class="main-content">
      <div class="charts-grid">
        <!-- Kecepatan Rata-rata Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.kecepatanRataRata.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.kecepatanRataRata.data"
                >
                  <div class="bar-label">{{ data.label }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.percentage"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value | number:'1.0-0' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SDLP Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.sdlp.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div class="bar-item" *ngFor="let data of chartData.sdlp.data">
                  <div class="bar-label">{{ data.label }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.percentage"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value | number:'1.0-0' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Waktu Reaksi PDT Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.waktuReaksiPDT.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.waktuReaksiPDT.data"
                >
                  <div class="bar-label">{{ data.label }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.percentage"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value | number:'1.0-0' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PDT Gagal Card -->
        <div class="chart-card">
          <div class="card-header">
            <h3 class="card-title">{{ chartData.pdtGagal.title }}</h3>
          </div>
          <div class="card-content">
            <div class="bar-chart">
              <div class="chart-container">
                <div
                  class="bar-item"
                  *ngFor="let data of chartData.pdtGagal.data"
                >
                  <div class="bar-label">{{ data.label }}</div>
                  <div class="bar-wrapper">
                    <div
                      class="bar-fill"
                      [style.width.%]="data.percentage"
                      [style.background]="getBarColor(data.value)"
                    ></div>
                  </div>
                  <div class="bar-value">{{ data.value | number:'1.0-0' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Trends Section -->
      <div class="performance-section">
        <h2 class="section-title">Tren Performa Mingguan</h2>
        <div class="trend-card">
          <div class="trend-chart">
            <div class="trend-container">
              <div
                class="trend-item"
                *ngFor="let value of performanceTrends.data; let i = index"
              >
                <div
                  class="trend-bar"
                  [style.height.%]="value"
                  [style.background]="getBarColor(value)"
                ></div>
                <div class="trend-label">{{ performanceTrends.labels[i] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Horizontal Sections Container -->
      <div class="horizontal-sections">
        <!-- Recent Activities Section -->
        <div class="activities-section">
          <h2 class="section-title">Aktivitas Terkini</h2>
          <div class="activities-grid">
            <div class="activity-card" *ngFor="let activity of recentActivities">
              <div class="activity-header">
                <div class="activity-icon">
                  <ion-icon [name]="getActivityIcon(activity.type)"></ion-icon>
                </div>
                <div class="activity-info">
                  <h4 class="activity-title" [title]="activity.title">{{ activity.title }}</h4>
                  <p class="activity-time">
                  </p>
                </div>
                <div class="activity-status" [class]="activity.status">
                  <ion-icon 
                    [name]="activity.status === 'completed' ? 'checkmark-circle-outline' : 'alert-circle-outline'"
                  ></ion-icon>
                  <span>{{ activity.status === 'completed' ? 'Selesai' : 
                         activity.status === 'warning' ? 'Peringatan' : 'Sukses' }}</span>
                </div>
              </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div class="notifications-section">
          <div class="section-header">
            <h2 class="section-title">Notifikasi</h2>
            <button class="mark-all-read" (click)="markAllAsRead()" *ngIf="hasUnreadNotifications()">
              <ion-icon name="checkmark-done-outline"></ion-icon>
              Tandai Semua Dibaca
            </button>
          </div>
          
          <div class="notifications-grid" [class.has-notifications]="notifications.length > 0">
            <!-- Empty State -->
            <div class="empty-state" *ngIf="!notifications.length">
              <ion-icon name="notifications-off-outline"></ion-icon>
              <p>Tidak ada notifikasi</p>
              <small>Semua notifikasi akan muncul di sini</small>
            </div>
            
            <!-- Notifications List -->
            <ng-container *ngIf="notifications.length > 0">
              <div 
                class="notification-card"
                *ngFor="let notification of notifications; trackBy: trackByNotificationId"
                [class.unread]="!notification.read"
                [@fadeIn]
                (click)="onNotificationClick(notification)"
              >
                <!-- Notification Header -->
                <div class="notification-header">
                  <!-- Icon with status indicator -->
                  <div class="notification-icon" [style.background]="getNotificationColor(notification.type) + '15'">
                    <ion-icon 
                      [name]="getNotificationIcon(notification.type)" 
                      [style.color]="getNotificationColor(notification.type)">
                    </ion-icon>
                    <span class="unread-indicator" *ngIf="!notification.read"></span>
                  </div>
                  
                  <!-- Notification Content -->
                  <div class="notification-content">
                    <div class="notification-title-wrapper">
                      <h4 class="notification-title">
                        {{ notification.title }}
                      </h4>
                      <span class="notification-time">
                        <ion-icon name="time-outline"></ion-icon>
                        {{ notification.time }}
                      </span>
                    </div>
                    <p class="notification-message">{{ notification.message }}</p>
                  </div>
                </div>
                
                <!-- Notification Actions -->
                <div class="notification-actions" *ngIf="!notification.read">
                  <button 
                    class="mark-read-btn"
                    (click)="$event.stopPropagation(); markNotificationAsRead(notification.id)">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    Tandai Dibaca
                  </button>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div
  class="profile-modal"
  *ngIf="showProfileModal"
  (click)="closeProfileModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Profil Pengguna</h2>
      <button class="close-btn" (click)="closeProfileModal()">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="profile-avatar-section">
        <div class="avatar-upload">
          <div class="avatar-preview">
            <span class="avatar-initial">{{ userInfo.initial }}</span>
          </div>
          <button class="avatar-change-btn" (click)="changeAvatar()">
            <ion-icon name="camera-outline"></ion-icon>
            Ganti Avatar
          </button>
        </div>
      </div>

      <div class="profile-form">
        <div class="form-group">
          <label for="userName">Nama Lengkap</label>
          <input
            type="text"
            id="userName"
            [(ngModel)]="editUserInfo.name"
            placeholder="Masukkan nama lengkap"
          />
        </div>

        <div class="form-group">
          <label for="userEmail">Email</label>
          <input
            type="email"
            id="userEmail"
            [(ngModel)]="editUserInfo.email"
            placeholder="Masukkan email"
          />
        </div>

        <div class="form-group">
          <label for="userPhone">Nomor Telepon</label>
          <input
            type="tel"
            id="userPhone"
            [(ngModel)]="editUserInfo.phone"
            placeholder="Masukkan nomor telepon"
          />
        </div>

        <div class="form-group">
          <label for="userStatus">Status</label>
          <select id="userStatus" [(ngModel)]="editUserInfo.status">
            <option value="Online">Online</option>
            <option value="Offline">Offline</option>
            <option value="Sibuk">Sibuk</option>
            <option value="Away">Away</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeProfileModal()">Batal</button>
      <button class="btn-save" (click)="saveProfile()">Simpan Perubahan</button>
    </div>
  </div>
</div>
